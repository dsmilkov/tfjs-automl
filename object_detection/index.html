<script src="https://unpkg.com/@tensorflow/tfjs-core/dist/tf-core.js"></script>
<script src="https://unpkg.com/@tensorflow/tfjs-converter/dist/tf-converter.js"></script>
<img id="img" width="500" src="test_image.jpg" /> 
<script>
'use strict';
function centerCrop(image) {
    image = image.expandDims().toFloat();
    // Each entry is [y1, x1, y2, x2].
    // y1 = 1 means the whole image height
    // x1 = 1 means the whole image width
    const boxes = [[0, 0, 1, 1]];
    const method = 'bilinear';
    const cropSize = [320, 320];
    const boxInd = [0];
    return tf.image.cropAndResize(image, boxes, boxInd, cropSize, method);
}

async function run() {
    const MODEL_URL = 'model.json';
    const model = await tf.loadGraphModel(MODEL_URL);
    let img = tf.browser.fromPixels(document.getElementById('img'));
    // console.log('Before we process', img.shape);
    // img = tf.tidy(() => centerCrop(img));
    img = img.expandDims().toFloat();
    //let [scores, boxes] = await model.executeAsync({'Preprocessor/map/TensorArrayStack/TensorArrayGatherV3': img}, ['Postprocessor/BatchMultiClassNonMaxSuppression/map/while/MultiClassNonMaxSuppression/TopKV2_5', 'Postprocessor/Reshape_2']);
    let [scores, boxes] = await model.executeAsync({'ToFloat': img}, ['Postprocessor/convert_scores', 'Postprocessor/Decode/stack']);
    scores.print(true);
    console.log('scores min/max', scores.min().dataSync()[0], scores.max().dataSync()[0]);
    boxes.print(true);
    
    // let [scores, boxes, classes] = await model.executeAsync({'ToFloat': img}, ['detection_scores', 'detection_boxes', 'detection_classes']);
    
    const n = 50;
    const start = performance.now();
    for (let i = 0; i < n; i++) {
        let [scores, boxes] = await model.executeAsync({'ToFloat': img}, ['Postprocessor/convert_scores', 'Postprocessor/Decode/stack']);
        tf.dispose([scores, boxes]);
    }
    console.log('Took', (performance.now() - start) / n);
}
tf.setBackend('webgl');
run();
</script>